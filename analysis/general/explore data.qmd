---
title: "explore data2"
format: html
---

# load data

```{r}
library(tidyverse)
library(tools)
source("helpers.R")

# datapath <- r"(D:\Data\3198-51\3198-51_recall_g0\M3_recall.csv)"
# metapath <- r"(D:\Data\3198-51\3198-51_recall_g0\Meta\cluster_info.tsv)"
# datapath <- r"(D:\Data\3198-51\3198-51_recall_g0\M3_recall.csv)"
# metapath <- r"(D:\Data\3198-51\3198-51_recall_g0\Meta\cluster_info.tsv)"
# depthpath <- r"(D:\3556-17\histology\tiffs\slices\iblnaive\channel_locations.json)"
# structure_path <- r"(C:\Users\Freitag\Documents\GitHub\Phd_Letzkus\pre_processing\Allenbrain_structure_tree.csv)"


datapath = "D:/Data/aligned/data_allUnits"
metapath = "D:/Data/aligned/meta"
depthpath = "D:/Data/aligned/depths"
structure_path <- r"(C:\Users\Freitag\Documents\GitHub\Phd_Letzkus\pre_processing\Allenbrain_structure_tree.csv)"


data <- process_all_data(
  datapath, 
  metapath,  
  depthpath,
  Alignment_State = 'Sound',
  out_dir   = "D:/Data/aligned/wrangled/chunks"
)






data %>% write_csv("D:/Data/aligned/wrangled/data.csv")


library(data.table)

folder <- "D:/Data/aligned/wrangled/chunks"
files <- list.files(folder, pattern = "\\.csv$", full.names = TRUE)

# target columns that every CSV should have
required_cols <- c("brain_region", "area")

for (f in files) {
  # read only the header
  header <- names(fread(f, nrows = 0))
  
  needs_change <- FALSE
  
  # check if V1 exists
  if ("V1" %in% header) needs_change <- TRUE
  
  # check if required columns are missing
  missing_cols <- setdiff(required_cols, header)
  if (length(missing_cols) > 0) needs_change <- TRUE
  
  # only load and resave if necessary
  if (needs_change) {
    dt <- fread(f)
    
    # remove V1 if it exists
    if ("V1" %in% names(dt)) dt[, V1 := NULL]
    
    # ensure required columns exist
    for (col in required_cols) {
      if (!(col %in% names(dt))) dt[, (col) := NA]
    }
    
    # reorder columns so all have the same order
    dt <- dt[, c(names(dt)[!names(dt) %in% required_cols], required_cols), with = FALSE]
    
    # overwrite the file
    fwrite(dt, f)
  }
}



# combine into one data.table
all_data <- rbindlist(all_data, fill = TRUE)

old <-  read.csv(file="D:/Data/aligned/wrangled/data_allUnits.csv",nrows=20)
new <-  read.csv(file="D:/Data/aligned/wrangled/data.csv",nrows=20)

### Trialless

gc()
#
#Trialless <- align_trials(all_data)
Trialless <- align_trials_multiple_files( "D:/Data/aligned/wrangled/chunks")
#all_data %>% write_csv("D:/Data/aligned/wrangled/data.csv")

rm(data)
gc()
shock <- read_csv(r"(D:\Data\aligned\extra\Shock_direction.csv)") %>% select(Animal = Animal2, direction)

Trialless <- Trialless %>% left_join(shock)



Trialless %>% write_csv("D:/Data/aligned/wrangled/Trialless_allUnits2.csv")



gc()


```

```{r}
library(tidyverse)
source("helpers.R")
data <- data.table::fread("D:/Data/aligned/wrangled/data.csv")
Trialless <- data.table::fread("D:/Data/aligned/wrangled/trialless_allUnits2.csv")
shock <- read_csv(r"(D:\Data\aligned\extra\Shock_direction.csv)")

Trialless <- Trialless %>% left_join(shock)
rm(shock)


list_of_zeta <- list.files(path = "D:/Data/aligned/zeta_allUnits",
                             pattern = "\\.csv$",
                             full.names = TRUE)
zeta <- read_csv(list_of_zeta, id = 'id') %>%  mutate(id = tools::file_path_sans_ext(basename(id)) ) %>% unite('cluster_id',id,unit) %>% filter(p_val < 0.05)

zeta_filter <- Trialless %>%
  distinct(cluster_id) %>%
  left_join(zeta) %>%
  na.omit() %>%
  select(-p_val) %>% pull(cluster_id)

gc()

Trialless %>% group_by(Animal,condition) %>% distinct(cluster_id) %>% count()
```

# Trialless
```{r}
# create data
g1_all <- Trialless  %>% 
  filter(between(rel_time, -20, 8)) %>%
  group_by(Animal,condition,rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(Animal,condition,trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>%  group_by(Animal,condition,trial_type) %>%
  mutate(smoothed1 = asymmetric_smooth(Zscore,window_high = 4, window_low = 25, threshold = 0.1)) %>%  ungroup()


g1_zeta  <- Trialless  %>% filter(cluster_id %in% zeta_filter) %>% 
  filter(between(rel_time, -20, 8)) %>%
  group_by(Animal,condition,rel_time, trial_type,area) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(Animal,condition,trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>%
  group_by(Animal,condition,trial_type) %>%
  mutate(smoothed1 = asymmetric_smooth(Zscore,window_high = 4, window_low = 25, threshold = 0.1)) %>% ungroup()


g1_zeta

# per session zeta

counts <- Trialless  %>% filter(cluster_id %in% zeta_filter)%>% group_by(Animal,condition) %>% distinct(cluster_id) %>% count()

g1_zeta %>% filter(between(rel_time,-0.5,6)) %>% ggplot(aes(rel_time, smoothed1, col = trial_type)) +
  geom_line() +
facet_grid(Animal~condition,scales='free')+
  geom_text(inherit.aes = F,
            data=counts,aes(x=5,y=2,label=n))+
  theme_minimal()


g1_zeta %>% filter(between(rel_time,-0.5,6)) %>% ggplot(aes(rel_time, Zscore, col = trial_type)) +
  geom_smooth(method='loess',span=0.05,se=F) +
facet_grid(Animal~condition,scales='free')+
  geom_text(inherit.aes = F,
            data=counts,aes(x=5,y=2,label=n))+
  theme_minimal()

# combined

g1_zeta  %>% mutate(trial_type = ifelse(trial_type=='Opto_Upwsweep','Opto_Upsweep',trial_type)) %>% filter(Animal != '17') %>% filter(between(rel_time,-0.5,6))  %>% group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>% separate_wider_delim(trial_type,delim='_', names=c('Opto','Stim_dir'), too_few='align_end') %>% replace_na(list(Opto='no'))%>% ggplot(aes(rel_time, Zscore, col = Opto)) +
  geom_smooth(span=0.05,se=F) +
  theme_minimal()+
  facet_wrap(~Stim_dir)

g1_zeta  %>% mutate(trial_type = ifelse(trial_type=='Opto_Upwsweep','Opto_Upsweep',trial_type)) %>% filter(Animal != '17') %>% filter(between(rel_time,-0.5,6))  %>% group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>% separate_wider_delim(trial_type,delim='_', names=c('Opto','Stim_dir'), too_few='align_end') %>% replace_na(list(Opto='no'))%>% ggplot(aes(rel_time, Zscore, col = Stim_dir)) +
  geom_smooth(span=0.05,se=F) +
  theme_minimal()+
  facet_wrap(~Opto)


g1_zeta  %>% mutate(trial_type = ifelse(trial_type=='Opto_Upwsweep','Opto_Upsweep',trial_type)) %>% filter(Animal != '17') %>% filter(between(rel_time,-0.5,6)) %>% separate_wider_delim(trial_type,delim='_', names=c('Opto','Stim_dir'), too_few='align_end') %>% group_by(rel_time, Opto,condition) %>%
  summarise(Zscore = mean(Zscore)) %>% replace_na(list(Opto='no'))%>% ggplot(aes(rel_time, Zscore,col=Opto)) +
  geom_smooth(span=0.05,se=F) +
  theme_minimal()+
  facet_wrap(~condition)















g1_zeta  %>% filter(between(rel_time,-0.5,6)) %>%  ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_smooth(method = "loess", span = 0.1,se=F)+
  facet_wrap(~condition,,scales='free')











g1_zeta  %>% mutate(trial_type = ifelse(trial_type=='Opto_Upwsweep','Opto_Upsweep',trial_type)) %>% filter(Animal != 'M2') %>% filter(between(rel_time,-.25,2.65)) %>% mutate(rel_time = round(rel_time))  %>% group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>% separate_wider_delim(trial_type,delim='_', names=c('Opto','Stim_dir'), too_few='align_end') %>% replace_na(list(Opto='no'))%>% ggplot(aes(rel_time, Zscore, col =   Opto,fill=Opto)) +
  geom_line() +
  geom_col()+
  theme_minimal()+
  facet_wrap(~Stim_dir,scales='free')


g1_zeta  %>% mutate(trial_type = ifelse(trial_type=='Opto_Upwsweep','Opto_Upsweep',trial_type)) %>% filter(Animal != 'M2') %>% filter(between(rel_time,-.25,2.65)) %>% mutate(rel_time = round(rel_time))  %>% group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>% separate_wider_delim(trial_type,delim='_', names=c('Opto','Stim_dir'), too_few='align_end') %>% replace_na(list(Opto='no')) %>% filter(Stim_dir =='Upsweep')



g1_zeta %>% group_by(rel_time) %>% summarise(smoothed1=mean(smoothed1)) %>%  filter(between(rel_time,-0.5,6)) %>% ggplot(aes(rel_time, smoothed1)) +
  geom_line(linewidth=1)+
  theme_minimal()+
  geom_vline(aes(xintercept = 0),linetype='dashed',col='red')+
   geom_vline(aes(xintercept = 0.5),linetype='dashed',col='red')+

ggsave('D:/figures/sound_responses.svg')

?geom_line()

Trialless %>% distinct(Animal,condition,cluster_id) %>% count(Animal,condition) %>% summarise(sum(n))



g1_zeta %>% unite('id',Animal,condition) %>% filter(between(rel_time,-1,6)) %>% group_by(id,rel_time) %>% summarise(smoothed1 = mean(smoothed1)) %>%  ggplot(aes(rel_time,smoothed1))+
  geom_line()+
  facet_wrap(~id,scales='free')



Trialless %>% filter(Animal==7633) %>% filter(between(rel_time,0,0.2)) %>% group_by(depth,condition) %>% summarise(act = mean(total_event_count)) %>% ggplot(aes(depth,act,col=condition))+
  geom_line()



g1_zeta  %>% mutate(trial_type = ifelse(trial_type=='Opto_Upwsweep','Opto_Upsweep',trial_type)) %>% filter(Animal!='7644')  %>% filter(between(rel_time,-0.5,6)) %>% separate_wider_delim(trial_type,delim='_', names=c('Opto','Stim_dir'), too_few='align_end') %>% group_by(rel_time, Opto,condition) %>%
  summarise(Zscore = mean(Zscore)) %>% replace_na(list(Opto='no'))%>% ggplot(aes(rel_time, Zscore,col=Opto)) +
  geom_smooth(span=0.05,se=F) +
  theme_minimal()+
  facet_grid(~condition)

```

# Trialless heatmap
```{r}

#prepare data

ord <- Trialless %>% filter(cluster_id != 90) %>% 
  filter(between(rel_time, 0, 0.2)) %>%
  group_by(cluster_id) %>%
  summarise(ord = mean(Zscore)) %>%
  arrange(ord) %>%
  mutate(cluster_id = as.factor(cluster_id)) %>%
  pull(cluster_id)


g2 <- Trialless %>%  filter(cluster_id != 'M2_naive_90') %>% 
  filter(between(rel_time, -0.5, 6)) %>%
  filter(cluster_id != 90) %>%
  group_by(cluster_id) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup() %>% filter(cluster_id %in% zeta_filter$cluster_id)
 # select(trial_type, cluster_id, Zscore, norm,rel_time, brain_region, area, depth)

# apply order
g2$cluster_id <- factor(g2$cluster_id, levels = ord)


# heatmap
# Split data by a grouping variable
plots <- g2 %>% unite('id',Animal,condition) %>% split(.$id) %>%
  map(~ ggplot(.x,aes(rel_time, cluster_id, fill = Zscore)) +
  geom_tile() +
  geom_vline(xintercept = 0, col = "grey", linetype = "dashed") +
  scale_fill_gradient2(low = "darkblue", mid = "beige", high = "red", midpoint = 0, limits = c(round(min(g2$Zscore)*0.6), round(max(g2$Zscore) * 0.3)), breaks = c(round(min(g2$Zscore)*0.6), round(max(g2$Zscore) * 0.3)), na.value = "black") +
  labs(fill = "Z- scored FR") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(-0.5, 6, by = 0.5)) 
  )


for (p in plots) print(p)


g2 %>%
  ggplot(aes(rel_time, cluster_id, fill = Zscore)) +
  geom_tile() +
  geom_vline(xintercept = 0, col = "grey", linetype = "dashed") +
  scale_fill_gradient2(low = "darkblue", mid = "beige", high = "red", midpoint = 0, limits = c(round(min(g2$Zscore)), round(max(g2$Zscore) * 0.3)), breaks = c(round(min(g2$Zscore)), round(max(g2$Zscore) * 0.3)), na.value = "black") +
  labs(fill = "Z- scored FR") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(-0.5, 6, by = 0.5)) +
  theme(axis.text.y = element_blank()) 

# rescaled color



g2 %>%
  ggplot(aes(rel_time, cluster_id, fill = Zscore)) +
  geom_tile() +
  geom_vline(xintercept = 0, col = "grey", linetype = "dashed") +
  scale_fill_gradientn(
    colours = c("darkblue", 'beige', "red"),
    values = scales::rescale(c(min(g2$Zscore), -0.5, 5)),
    limits = c(min(g2$Zscore), 5),
    oob = scales::squish,  # This makes values >10 show as red
    na.value = "black"
  ) +
  labs(fill = "Z-scored FR") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(-0.5, 6, by = 0.5)) +
  theme(axis.text.y = element_blank())

# normalizing rows
g2  %>%
  ggplot(aes(rel_time, as.factor(cluster_id), fill = norm)) +
  geom_tile() +
  labs(fill = "Z- scored FR") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(-0.5, 6, by = 0.5)) +
  scale_fill_gradient(low = "beige", high = "red", limits = c(0,1), breaks = c(0,1), na.value = "black") 


# heatmaps using base R

mat <- g2 %>%
  filter(cluster_id != 90) %>%
  group_by(rel_time, cluster_id) %>%
  summarise(Zscore = mean(Zscore)) %>%
  pivot_wider(names_from = rel_time, values_from = Zscore) %>%
  column_to_rownames("cluster_id") %>%
  as.matrix()
heatmap(mat, Colv = NA, Rowv = NA, scale = "none")


heatmap(mat, Colv = NA, scale = "none")

heatmap(mat, Colv = NA, Rowv = NA, scale = "row")
heatmap(mat, Colv = NA, Rowv = NA, scale = "column")
heatmap(mat, Colv = NA, Rowv = NA, scale = "none")


heatmap(mat, Colv = NA, scale = "none")

## shwoing depth

# facets

g2 <- Trialless %>%  filter(cluster_id != 'M2_naive_90') %>% mutate(area= ifelse(area=='AUD','Cortex','subcortical')) %>% 
  filter(between(rel_time, -0.5, 6)) %>%
  filter(cluster_id != 90) %>%
  group_by(cluster_id,area) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup() %>% filter(cluster_id %in% zeta_filter)

g2  %>%
  ggplot(aes(rel_time, as.factor(cluster_id), fill = Zscore)) +
  geom_tile() +
  scale_fill_gradient2(low = "darkblue", mid = "beige", high = "red", midpoint = 0, limits = c(round(min(g2$Zscore) * 0.9), round(max(g2$Zscore) * 0.7)), breaks = c(round(min(g2$Zscore) * 0.9), round(max(g2$Zscore) * 0.7)), na.value = "black") +
  labs(fill = "Z- scored FR") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(-0.5, 6, by = 0.5)) +
  theme(axis.text.y = element_blank()) +
  facet_grid(area ~ 1, scale = "free", space = "free")


 # no factes but lines

lines <- g2 %>%
  distinct(cluster_id, brain_region, depth, area) %>%
  arrange(-depth) %>%
  group_by(brain_region) %>%
  slice_min(depth, with_ties = F) %>%
  filter(area != "undefined")

g2 %>%
  ggplot(aes(rel_time, reorder(as.factor(cluster_id), depth), fill = Zscore)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", mid = "beige", high = "red", midpoint = , limits = c(round(min(g2$Zscore)), round(max(g2$Zscore) * 0.2)), breaks = c(round(min(g2$Zscore)), round(max(g2$Zscore) * 0.2)), na.value = "darkred") +
  labs(fill = "Z- scored FR") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(-0.5, 6, by = 0.5)) +
  theme_classic()+
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank()) +
  geom_hline(data = lines, aes(yintercept = as.factor(cluster_id))) +
  geom_text(data = lines, aes(x = -0.7, y = reorder(as.factor(cluster_id), depth), label = brain_region), inherit.aes = F, nudge_y = +1.5)





#### try


g2 <- Trialless %>%  filter(cluster_id != 'M2_naive_90') %>% mutate(area= ifelse(area=='AUD','Cortex','subcortical')) %>% replace_na(list(area='subcortical')) %>% 
  filter(between(rel_time, -0.5, 5)) %>%
  filter(cluster_id != 90) %>%
  group_by(rel_time,cluster_id,area) %>%
  summarise(Zscore= mean(Zscore),norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup() %>% filter(cluster_id %in% zeta_filter)

g2  %>%
  ggplot(aes(rel_time, as.factor(cluster_id), fill = Zscore)) +
  geom_tile() +
  scale_fill_gradient2(low = "darkblue", mid = "beige", high = "red", midpoint = 0, limits = c(round(min(g2$Zscore) * 1), round(max(g2$Zscore) * 0.6)), breaks = c(round(min(g2$Zscore) * 1), round(max(g2$Zscore) * 0.6)), na.value = "black") +
  labs(fill = "Z- scored FR") +
  theme_void() +
   theme(
    axis.ticks.x = element_line(),
    axis.text.x = element_text(),
    axis.title.x = element_text()
  )+
  scale_x_continuous(breaks = seq(-0.5, 6, by = 0.5)) +
  theme(axis.text.y = element_blank()) 
  facet_wrap( scales = "free", ncol = 2)
  ggsave('D:/figures/Heatmap2.png')




mat_cor <- g2 %>% filter(area=='Cortex') %>% 
  filter(cluster_id != 90) %>%
  group_by(rel_time, cluster_id) %>%
  summarise(Zscore = mean(Zscore)) %>%
  pivot_wider(names_from = rel_time, values_from = Zscore) %>%
  column_to_rownames("cluster_id") %>%
  as.matrix()
heatmap(mat_cor, Colv = NA, Rowv = NA, scale = "none")



mat_sub <- g2 %>% filter(area!='Cortex') %>% 
  filter(cluster_id != 90) %>%
  group_by(rel_time, cluster_id) %>%
  summarise(Zscore = mean(Zscore)) %>%
  pivot_wider(names_from = rel_time, values_from = Zscore) %>%
  column_to_rownames("cluster_id") %>%
  as.matrix()
heatmap(mat_sub, Colv = NA, Rowv = NA, scale = "none")


g2 %>% select(!norm) %>% write_csv('D:/g2.csv')

```

# look at single trials, all units


```{r}
unitless <- data %>%
  # Step 1: Calculate n_trials (same as original)
  left_join(
    data %>%
      group_by(trial_type) %>%
      summarise(n_units = n_distinct(cluster_id), .groups = "drop"),
    by = "trial_type"
  ) %>%
  # Step 2: Pre-aggregate event_count by the grouping variables + metadata
  # This replaces the expensive group_by + mutate(sum()) + distinct pattern
  group_by(trial_type, rel_time, aligntrial, n_units,Animal,condition) %>%
  summarise(total_event_count = sum(event_count), .groups = "drop") %>%
  # Step 3: Calculate rate (same formula as original)
  mutate(rate = total_event_count / n_units / 0.01) %>%
  # Step 4: Clean up and calculate Z-score
  select(-total_event_count, -n_units)
baseline <- unitless %>%
  filter(between(rel_time, -10, -0.1)) %>%
  summarise(cl_mean = mean(rate), cl_sd = sd(rate))
unitless <- unitless %>%
  group_by(aligntrial) %>%
  mutate(Zscore = (rate - baseline$cl_mean) / baseline$cl_sd) %>%
  ungroup()

g3 <- unitless %>%
  filter(between(rel_time, -1, 6.5)) %>%
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() # %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore))



unitless %>% unite('id',Animal,condition) %>% 
  filter(between(rel_time, 0.5, 0.6)) %>%
  group_by(aligntrial,id) %>%
  summarise(peak = mean(Zscore)) %>%
  ggplot(aes(aligntrial, peak,group=id,col=id)) +
  geom_point() +
  geom_smooth(method = "lm")


unitless %>%
  filter(between(rel_time, -0.1, 5)) %>%
  ggplot(aes(rel_time, Zscore, col = aligntrial)) +
  geom_smooth(span = 0.2, aes(group = aligntrial), se = F) +
  theme_minimal()


unitless %>%
  filter(between(rel_time, -0.1, 5)) %>%
  group_by(aligntrial) %>%
  summarise(m = mean(Zscore)) %>%
  ggplot(aes(aligntrial, m)) +
  geom_point() +
  theme_minimal()

unitless %>%
  mutate(peak = case_when(
    between(rel_time, 0, 0.1) ~ 1,
    between(rel_time, 1, 1.1) ~ 2,
    between(rel_time, 2, 2.1) ~ 3,
    between(rel_time, 3, 3.1) ~ 4,
    between(rel_time, 4, 4.1) ~ 5
  )) %>%
  na.omit() %>%
  group_by(aligntrial, peak) %>%
  summarise(m = mean(Zscore)) %>%
  ggplot(aes(aligntrial, m)) +
  geom_point() +
  geom_smooth(method = "lm")+
facet_wrap(~peak, scales = "free")


unitless %>%
  mutate(peak = case_when(
    between(rel_time, 0, 0.1) ~ 1,
    between(rel_time, 1, 1.1) ~ 2,
    between(rel_time, 2, 2.1) ~ 3,
    between(rel_time, 3, 3.1) ~ 4,
    between(rel_time, 4, 4.1) ~ 5
  )) %>%
  na.omit() %>%
  group_by(aligntrial,peak) %>%
  summarise(m = mean(Zscore)) %>%  group_by(peak) %>%
  mutate(m2 = mean(m)) %>% ggplot(aes(as.factor(peak),m))+
  geom_boxplot()+
  geom_line(aes(peak,m2),col='red')+
geom_point(aes(peak,m2),col='red')



unitless %>%
  mutate(peak = case_when(
    between(rel_time, 0.5, 0.6) ~ 1,
    between(rel_time, 1.5, 1.6) ~ 2,
    between(rel_time, 2.5, 2.6) ~ 3,
    between(rel_time, 3.5, 3.6) ~ 4,
    between(rel_time, 4.5, 4.6) ~ 5
  )) %>%
  na.omit() %>%
  group_by(aligntrial,peak) %>%
  summarise(m = mean(Zscore)) %>%  group_by(peak) %>%
  mutate(m2 = mean(m)) %>% ggplot(aes(as.factor(peak),m))+
  geom_boxplot()+
  geom_line(aes(peak,m2),col='red')


unitless %>% unite('id',Animal,condition)  %>% 
  mutate(peak = case_when(
    between(rel_time, 0.5, 0.6) ~ 1,
    between(rel_time, 1.5, 1.6) ~ 1,
    between(rel_time, 2.5, 2.6) ~ 1,
    between(rel_time, 3.5, 3.6) ~ 1,
    between(rel_time, 4.5, 4.6) ~ 1
  )) %>% separate_wider_delim(aligntrial,delim='_',names=c('aligntrial','B','C')) %>% mutate(aligntrial = as.numeric(aligntrial)) %>% 
  na.omit() %>%
  group_by(aligntrial, peak,id) %>%
  summarise(m = mean(Zscore)) %>%
  ggplot(aes(aligntrial, m,col=id)) +
  geom_point() +
  geom_smooth(method = "lm")+
facet_wrap(~id, scales = "free")



unitless %>% unite('id',Animal,condition)  %>% 
  mutate(peak = case_when(
    between(rel_time, 0, 0.1) ~ 1,
    between(rel_time, 1, 1.1) ~ 1,
    between(rel_time, 2, 2.1) ~ 1,
    between(rel_time, 3, 3.1) ~ 1,
    between(rel_time, 4, 4.1) ~ 1
  ))%>% separate_wider_delim(aligntrial,delim='_',names=c('aligntrial','B','C')) %>% mutate(aligntrial = as.numeric(aligntrial)) %>% 
  na.omit() %>%
  group_by(aligntrial, peak,id) %>%
  summarise(m = mean(Zscore)) %>%
  ggplot(aes(aligntrial, m,col=id)) +
  geom_point() +
  geom_smooth(method = "lm")+
facet_wrap(~id, scales = "free")
```


# ZETA
```{r}

list_of_zeta <- list.files(path = "D:/Data/aligned/zeta_allUnits",
                             pattern = "\\.csv$",
                             full.names = TRUE)
  zeta <- read_csv(list_of_zeta, id = 'id') %>%  mutate(id = tools::file_path_sans_ext(basename(id)) ) %>% unite('cluster_id',id,unit) %>% filter(p_val < 0.05)


# on_only <- on %>% anti_join(off, by = join_by(unit))
# off_only <- off %>% anti_join(on, by = join_by(unit))
# 
# on_of <- rbind(on_only, off_only)
# 
# all2 <- all %>% filter(!unit %in% on_of$unit)
# 
# zeta <- rbind(on_of, all2)



zeta_filter <- data %>%
  distinct(cluster_id) %>%
  left_join(zeta) %>%
  na.omit() %>%
  select(-p_val)

T2 <- Trialless %>% filter(cluster_id %in% zeta$cluster_id)

T2 %>% distinct(cluster_id)

g1 <- T2 %>%
  filter(between(rel_time, -1, 6.5)) %>%
  group_by(rel_time) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() # %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore))





g1 %>% ggplot(aes(rel_time, Zscore)) +
  geom_line() +
  theme_minimal() 


ARR <- Trialless %>%
  filter(cluster_id == 24, between(rel_time, -2, 6)) %>%
  group_by(rel_time) %>%
  summarise(Zscore = mean(Zscore), rate = mean(rate)) %>%
  mutate(smooth = zoo::rollmean.default(Zscore, 8, "extend"))
ARR %>% ggplot(aes(rel_time, smooth)) +
  geom_line()


ARR <- Trialless %>%
  filter(cluster_id == 24, between(rel_time, -2, 6)) %>%
  group_by(rel_time) %>%
  summarise(Zscore = mean(Zscore), rate = mean(rate)) %>%
  mutate(smooth = zoo::rollmean.default(Zscore, 25, "extend"))
ARR %>% ggplot(aes(rel_time, smooth)) +
  geom_line()

ARR <- Trialless %>%
  filter(cluster_id == 24, between(rel_time, -2, 6)) %>%
  group_by(rel_time) %>%
  summarise(Zscore = mean(Zscore), rate = mean(rate)) %>%
  mutate(smooth = zoo::rollmean.default(Zscore, 1, "extend"))
ARR %>% ggplot(aes(rel_time, smooth)) +
  geom_line()+
  geom_vline(aes(xintercept = 0.5))


zoo::rollmean.default(ARR$Zscore, 3)


zeta %>% count(cluster_id)
```

# using UMAP to find response pattern types
```{r}
# first try using all data
library(umap)

iris.data <- iris[, grep("Sepal|Petal", colnames(iris))]
iris.labels <- iris[, "Species"]

iris
Trialless %>% distinct(trial_type)
AA <- Trialless %>% filter(cluster_id %in% T2$cluster_id) %>% 
  filter(!cluster_id %in% c('M2_naive_90','M4_recall_64') )%>%
  filter(between(rel_time, -0.05, 0.999)) %>% filter(trial_type %in% c('Downsweep','Upsweep')) %>% 
  group_by(rel_time, cluster_id) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(cluster_id) %>%
  mutate(Zscore = zoo::rollmean.default(Zscore, 5, "extend")) %>%
  ungroup() %>% group_by(cluster_id) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup() %>% select(-Zscore) %>% 
  pivot_wider(names_from = rel_time, values_from = norm)
AA <- AA %>% na.omit()
AA.data <- AA %>% select(-cluster_id)
AA.labels <- AA %>% select( cluster_id)

AA.umap <- umap::umap(AA.data,n_components = 2)
plotda <- tibble(A1 = AA.umap$layout[, 1], A2 = AA.umap$layout[, 2], units = AA.labels$cluster_id)
plotda %>% ggplot(aes(A1, A2)) +
  geom_point() 
  geom_text(aes(label = units))

AA.umap$layout

?umap::umap.default

umap::umap.defaults
```


```{r}


# selecting peaks as features.

JP <- T2 %>%
  mutate(peak = case_when(
    between(rel_time, 0, 0.1) ~ 2,
    between(rel_time, 1, 1.1) ~ 3,
    between(rel_time, 2, 2.1) ~ 4,
    between(rel_time, 3, 3.1) ~ 5,
    between(rel_time, 4, 4.1) ~ 6,
    between(rel_time, 0.5, 0.6) ~ 7,
    between(rel_time, 1.5, 1.6) ~ 8,
    between(rel_time, 2.5, 2.6) ~ 9,
    between(rel_time, 3.5, 3.6) ~ 10,
    between(rel_time, 4.5, 4.6) ~ 11,
    between(rel_time, -2, -0.01) ~ 1,
    between(rel_time, 5, 5.5) ~ 12
  )) %>%
  na.omit() %>%
  group_by(cluster_id, peak) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(cluster_id) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup()

JP

AA <- JP %>%
  select(-Zscore) %>%
  filter(cluster_id != 'M2_naive_90') %>%
  pivot_wider(names_from = peak, values_from = norm)
AA
AA.data <- AA %>% select(-cluster_id,)
AA.labels <- AA %>% select( cluster_id)

AA.umap <- umap::umap(AA.data)



plotda <- tibble(A1 = AA.umap$layout[, 1], A2 = AA.umap$layout[, 2], units = AA.labels$cluster_id)
plotda %>% ggplot(aes(A1, A2)) +
  geom_point() +
  geom_text(aes(label = units))

AA.umap$knn$indexes

kmd <- plotda %>%
  select(A1, A2) %>%
  as.matrix()
kmr <- kmeans(kmd, 5, iter.max = 25, nstart = 3)

plotda %>%
  mutate(kmc = kmr$cluster) %>%
  ggplot(aes(A1, A2, col = as.factor(kmc))) +
  geom_point() +
  geom_text(aes(label = units))


filt_kmean <- plotda %>%
  mutate(kmc = kmr$cluster) %>%
  select(cluster_id = units, kmc)

Trialless %>%
  filter(cluster_id != 90) %>%
  filter(between(rel_time, -1, 6.5)) %>%
  left_join(filt_kmean) %>%
  group_by(rel_time, kmc) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>%
  ggplot(aes(rel_time, Zscore, col = as.factor(kmc))) +
  geom_line() +
  facet_wrap(~kmc)




JP %>%
  group_by(cluster_id) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ggplot(aes(peak, norm, col = as.factor(cluster_id))) +
  geom_line()



# use means off all peaks as feautures


JP <- T2 %>% 
  mutate(peak = case_when(
    between(rel_time, 0, 0.1) ~ 2,
    between(rel_time, 1, 1.1) ~ 2,
    between(rel_time, 2, 2.1) ~ 2,
    between(rel_time, 3, 3.1) ~ 2,
    between(rel_time, 4, 4.1) ~ 2,
    between(rel_time, 0.5, 0.6) ~ 3,
    between(rel_time, 1.5, 1.6) ~ 3,
    between(rel_time, 2.5, 2.6) ~ 3,
    between(rel_time, 3.5, 3.6) ~ 3,
    between(rel_time, 4.5, 4.6) ~ 3,
    between(rel_time, -2, -0.01) ~ 1,
    between(rel_time, 5, 5.5) ~ 4
  )) %>%
  na.omit() %>%
  group_by(cluster_id, peak) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(cluster_id) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup()




AA <- JP %>%
  select(-Zscore) %>%
  filter(cluster_id != 90) %>%
  filter() %>%
  pivot_wider(names_from = peak, values_from = norm)
AA
AA.data <- AA %>% select(-cluster_id)
AA.labels <- AA %>% select(cluster_id)

AA.umap <- umap::umap(AA.data)



plotda <- tibble(A1 = AA.umap$layout[, 1], A2 = AA.umap$layout[, 2], units = AA.labels$cluster_id)
plotda %>% ggplot(aes(A1, A2, col = mod)) +
  geom_point() +
  geom_text(aes(label = units))

AA.umap$knn$indexes

kmd <- plotda %>%
  select(A1, A2) %>%
  as.matrix()
kmr <- kmeans(kmd, 4, iter.max = 25, nstart = 3)

plotda %>%
  mutate(kmc = kmr$cluster) %>%
  ggplot(aes(A1, A2, col = as.factor(kmc))) +
  geom_point() +
  geom_text(aes(label = units))


filt_kmean <- plotda %>%
  mutate(kmc = kmr$cluster) %>%
  select(cluster_id = units, kmc)

Trialless %>%
  filter(cluster_id != 90) %>%
  filter(between(rel_time, -1, 6.5)) %>%
  left_join(filt_kmean) %>%
  group_by(rel_time, kmc) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>%
  ggplot(aes(rel_time, Zscore, col = as.factor(kmc))) +
  geom_line() +
  facet_wrap(~kmc)

# use aligned peaks and post_peaks



JP <- T2 %>%
  mutate(peak = case_when(
    between(rel_time, 0, 0.1) ~ 2,
    between(rel_time, 1, 1.1) ~ 2,
    between(rel_time, 2, 2.1) ~ 2,
    between(rel_time, 3, 3.1) ~ 2,
    between(rel_time, 4, 4.1) ~ 2,
    between(rel_time, 0.11, 0.49) ~ 3,
    between(rel_time, 1.11, 1.49) ~ 3,
    between(rel_time, 2.11, 2.49) ~ 3,
    between(rel_time, 3.11, 3.49) ~ 3,
    between(rel_time, 4.11, 4.49) ~ 3,
    between(rel_time, 0.5, 0.6) ~ 4,
    between(rel_time, 1.5, 1.6) ~ 4,
    between(rel_time, 2.5, 2.6) ~ 4,
    between(rel_time, 3.5, 3.6) ~ 4,
    between(rel_time, 4.5, 4.6) ~ 4,
    between(rel_time, 0.61, 0.99) ~ 5,
    between(rel_time, 1.61, 1.99) ~ 5,
    between(rel_time, 2.61, 2.99) ~ 5,
    between(rel_time, 3.61, 3.99) ~ 5,
    between(rel_time, 4.61, 4.99) ~ 5,
    between(rel_time, -2, -0.01) ~ 1,
    between(rel_time, 5, 5.5) ~ 6
  )) %>%
  na.omit() %>%
  group_by(cluster_id, peak, mod) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(cluster_id) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup()

AA <- JP2 %>%
  select(-Zscore) %>%
  filter(cluster_id != 90) %>%
  filter(mod != "NA") %>%
  pivot_wider(names_from = peak, values_from = norm)
AA
AA.data <- AA %>% select(-cluster_id, -mod)
AA.labels <- AA %>% select(mod, cluster_id)

AA.umap <- umap(AA.data)



plotda <- tibble(A1 = AA.umap$layout[, 1], A2 = AA.umap$layout[, 2], mod = AA.labels$mod, units = AA.labels$cluster_id)
plotda %>% ggplot(aes(A1, A2, col = mod)) +
  geom_point() +
  geom_text(aes(label = units))

AA.umap$knn$indexes

kmd <- plotda %>%
  select(A1, A2) %>%
  as.matrix()
kmr <- kmeans(kmd, 5, iter.max = 25, nstart = 3)

plotda %>%
  mutate(kmc = kmr$cluster) %>%
  ggplot(aes(A1, A2, col = as.factor(kmc))) +
  geom_point() +
  geom_text(aes(label = units))


filt_kmean <- plotda %>%
  mutate(kmc = kmr$cluster) %>%
  select(cluster_id = units, kmc)

Trialless %>%
  filter(cluster_id != 90) %>%
  filter(between(rel_time, -1, 6.5)) %>%
  left_join(filt_kmean) %>%
  group_by(rel_time, kmc) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>%
  ggplot(aes(rel_time, Zscore, col = as.factor(kmc))) +
  geom_line() +
  facet_wrap(~kmc)

JP
group_by()
bl <- JP %>%
  filter(cluster_id != 90) %>%
  group_by(cluster_id) %>%
  filter(peak == 1) %>%
  mutate(bl = norm) %>%
  select(cluster_id, bl)
JP2 <- JP %>%
  filter(cluster_id != 90) %>%
  left_join(bl) %>%
  group_by(cluster_id) %>%
  mutate(norm = norm - bl) %>%
  ggplot(aes(peak, norm, col = as.factor(cluster_id))) +
  geom_line()


## super cut
sc <- JP %>%
  filter(cluster_id != 90) %>%
  left_join(bl) %>%
  group_by(cluster_id) %>%
  mutate(norm = norm - bl) %>%
  mutate(catr = case_when(
    between(norm, 0.3, 1) ~ 1,
    between(norm, -0.299, 0.299) ~ 0,
    between(norm, -1, -0.3) ~ -1,
  )) %>%
  filter(peak > 1)

sc %>% ggplot(aes(peak, catr, col = as.factor(cluster_id))) +
  geom_line()


AA <- sc %>%
  select(cluster_id, peak, mod, catr) %>%
  filter(cluster_id != 90) %>%
  filter(mod != "NA") %>%
  pivot_wider(names_from = peak, values_from = catr)
AA
AA.data <- AA %>% select(-cluster_id, -mod)
AA.labels <- AA %>% select(mod, cluster_id)

AA.umap <- umap(AA.data)



plotda <- tibble(A1 = AA.umap$layout[, 1], A2 = AA.umap$layout[, 2], units = AA.labels$cluster_id)
plotda %>% ggplot(aes(A1, A2, col = mod)) +
  geom_point() +
  geom_text(aes(label = units))

AA.umap$knn$indexes


######################
kmd <- plotda %>%
  select(A1, A2) %>%
  as.matrix()
kmr <- kmeans(kmd, 6, iter.max = 50, nstart = 6)

plotda %>%
  mutate(kmc = kmr$cluster) %>%
  ggplot(aes(A1, A2, col = as.factor(kmc))) +
  geom_point() 
  geom_text(aes(label = units))


filt_kmean <- plotda %>%
  mutate(kmc = kmr$cluster) %>%
  select(cluster_id = units, kmc)

Trialless %>%
  filter(cluster_id %in% filt_kmean$cluster_id) %>%
  left_join(filt_kmean) %>% 
 filter(between(rel_time, -0.05, 0.999)) %>% 
  group_by(rel_time, kmc) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>%
  ggplot(aes(rel_time, Zscore, col = as.factor(kmc))) +
  geom_smooth(span=0.05)+
  geom_line()+
  facet_wrap(~kmc,scales='free')


#################

filt_kmean
g1 <- Trialless %>% left_join(filt_kmean) %>% filter(kmc %in% c(4)) %>% 
  filter(between(rel_time, -1, 5)) %>%
  group_by(Animal,condition,rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(Animal,condition,trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()


g1 <- g1 %>%
  group_by(Animal,condition,trial_type) %>%
  mutate(smoothed1 = asymmetric_smooth(Zscore,window_high = 4, window_low = 25, threshold = 0.1))


g1 %>% filter(between(rel_time,-0.5,6)) %>% ggplot(aes(rel_time, smoothed1, col = as.factor(trial_type))) +
  geom_line() +
facet_grid(Animal~condition)

g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_line() +
   facet_grid(Animal~condition,,scales='free')

g1  %>% ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_smooth(method = "loess", span = 0.1,se=F)+
  facet_grid(Animal~condition,,scales='free')



###################

Trialless %>%
  filter(cluster_id %in% filt_kmean$cluster_id) %>%
  left_join(filt_kmean) %>% 
  filter(between(rel_time, -0.05, 1.1)) %>% 
  group_by(cluster_id,rel_time, kmc) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(kmc ==5) %>% 
  ggplot(aes(rel_time, Zscore)) +
  geom_smooth(span=0.05)+
  facet_wrap(~cluster_id,scales='free')



JP %>%   left_join(filt_kmean) %>% group_by(kmc,peak) %>% summarise(norm = mean(norm)) %>%  ggplot(aes(peak,norm))+
  geom_line()+
  facet_wrap(~kmc)
```


```{r}
AA <- Trialless %>%
  
  filter(mod != "NA") %>%
  filter(between(rel_time, 0, 5)) %>%
  group_by(rel_time, cluster_id) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(cluster_id) %>%
  mutate(Zscore = zoo::rollmean.default(Zscore, 25, "extend")) %>%
  ungroup() %>%
  pivot_wider(names_from = rel_time, values_from = Zscore)


pc <- prcomp(AA.data, scale. = T)

r <- as_tibble(pc$x)



plotda <- tibble(A1 = r$PC1, A2 = r$PC2, A3 = r$PC3, mod = AA.labels$mod, units = AA.labels$cluster_id)
plotda %>% ggplot(aes(A1, A2)) +
  geom_point() 
  geom_text(aes(label = units))

plotda %>% ggplot(aes(A1, A3)) +
  geom_point() 
  geom_text(aes(label = units))

plotda %>% ggplot(aes(A3, A2, col = mod)) +
  geom_point() +
  geom_text(aes(label = units))




T2 %>%
  filter(cluster_id != 90) %>%
  filter(mod != "NA") %>%
  filter(between(rel_time, 0, 1)) %>%
  group_by(rel_time, cluster_id, mod) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(cluster_id) %>%
  mutate(Zscore = zoo::rollmean.default(Zscore, 1, "extend")) %>%
  mutate(norm = (Zscore - min(Zscore)) / (max(Zscore) - min(Zscore))) %>%
  ungroup() %>%
  ggplot(aes(rel_time, Zscore, group = cluster_id, col = as.factor(mod))) +
  geom_line()
```




```{r}
g2 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_line()

g2 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_smooth(method = "loess", span = 0.1)
g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_smooth(method = "loess", span = 0.1)


library(pracma)

gaussian_filter1d <- function(x, sigma) {
  ksize <- ceiling(sigma * 6)
  t <- -ksize:ksize
  kernel <- exp(-t^2 / (2 * sigma^2))
  kernel <- kernel / sum(kernel)

  # reflect padding (like scipy.ndimage default mode="reflect")
  xpad <- c(rev(head(x, ksize)), x, rev(tail(x, ksize)))

  # full convolution
  ypad <- stats::convolve(xpad, rev(kernel), type = "open")

  # crop back to original length
  start <- ksize + 1
  end <- start + length(x) - 1
  ypad[start:end]
}


?convolve

g1 <- g1 %>%
  group_by(trial_type) %>%
  mutate(smooth = gaussian_filter1d(Zscore, sigma = 4))
g2 <- g2 %>%
  group_by(trial_type) %>%
  mutate(smooth = gaussian_filter1d(Zscore, sigma = 4))



g1 %>% ggplot(aes(rel_time, smooth, col = as.factor(trial_type))) +
  geom_line()

g2 %>% ggplot(aes(rel_time, smooth, col = as.factor(trial_type))) +
  geom_line()


data %>% write_csv(r"(D:\3556-17\3556-17_naive_g0\Data.csv)")
Trialless %>% write_csv(r"(D:\3556-17\3556-17_naive_g0\Trialless.csv)")
g1 %>% write_csv(r"(D:\3556-17\3556-17_naive_g0\g1.csv)")


g1 %>% ggplot(aes(rel_time, smooth, col = as.factor(trial_type))) +
  geom_line()
g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_smooth(method = "loess", span = 0.05, se = F)



g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_line() +
  xlim(4.2, 5)
```



```{r}
datarange <- data %>%
  arrange(time_bin) %>%
  mutate(aligntrial = cumsum(c(TRUE, diff(rel_time) < -1)))


data2 <- datarange %>%
  group_by(aligntrial) %>%
  mutate(trial_type = first(trial_type)) %>%
  ungroup()


Trialless <- data2 %>%
  # Step 1: Calculate n_trials (same as original)
  left_join(
    data %>%
      group_by(trial_type) %>%
      summarise(n_trials = n_distinct(trial_number), .groups = "drop"),
    by = "trial_type"
  ) %>%
  # Step 2: Pre-aggregate event_count by the grouping variables + metadata
  # This replaces the expensive group_by + mutate(sum()) + distinct pattern
  group_by(trial_type, rel_time, cluster_id, n_trials, brain_region, area) %>%
  summarise(total_event_count = sum(event_count), .groups = "drop") %>%
  # Step 3: Calculate rate (same formula as original)
  mutate(rate = total_event_count / n_trials / 0.01) %>%
  # Step 4: Clean up and calculate Z-score
  select(-total_event_count, -n_trials) %>%
  group_by(cluster_id) %>%
  mutate(Zscore = (rate - mean(rate)) / sd(rate)) %>%
  ungroup()



g1 <- Trialless %>%
  filter(between(rel_time, -10, 10)) %>%
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(trial_type) %>%
  mutate(Zscore = Zscore - mean(Zscore))
g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_line() +
  xlim(-0.5, 6)


data %>%
  filter(between(rel_time, -5, 6)) %>%
  group_by(trial_type) %>%
  count(rel_time) %>%
  ggplot(aes(rel_time, n, col = as.factor(trial_type))) +
  geom_line()

data %>%
  filter(time_bin > 206) %>%
  filter(cluster_id == 41)


datarange <- data %>%
  arrange(time_bin) %>%
  mutate(aligntrial = cumsum(c(TRUE, diff(rel_time) < -1))) %>%
  group_by(aligntrial) %>%
  reframe(range = range(rel_time)) %>%
  group_by() %>%
  summarise(
    common_min = max(range[c(TRUE, FALSE)]), # max of minimums
    common_max = min(range[c(FALSE, TRUE)]) # min of maximums
  )

datarange <- data %>%
  arrange(time_bin) %>%
  mutate(aligntrial = cumsum(c(TRUE, diff(rel_time) < -1)))

datarange

data2 %>%
  filter(between(rel_time, -5, 6)) %>%
  group_by(trial_type) %>%
  count(rel_time) %>%
  count(trial_type, n)


data %>% count(cluster_id, time_bin)

data %>%
  group_by(cluster_id) %>%
  count(time_bin)


library(data.table)

setDT(data) # convert to data.table by reference

res <- data[, .N, by = .(trial_type, cluster_id, time_bin)]


res %>%
  count(cluster_id, trial_type) %>%
  count(trial_type)



data2 %>%
  filter(between(rel_time, 5, 6)) %>%
  group_by(trial_type) %>%
  count(rel_time) %>%
  ggplot(aes(rel_time, n, col = as.factor(trial_type))) +
  facet_wrap(~trial_type) +
  geom_line()

g1 %>% ggplot(aes(rel_time, smoothed1, col = as.factor(trial_type))) +
  geom_line() +
  xlim(-0.5, 6)
```

```{r}
Trialless <- data %>%
  # Step 1: Calculate n_trials (same as original)
  left_join(
    data %>%
      group_by(trial_type) %>%
      summarise(n_trials = n_distinct(trial_number), .groups = "drop"),
    by = "trial_type"
  ) %>%
  # Step 2: Pre-aggregate event_count by the grouping variables + metadata
  # This replaces the expensive group_by + mutate(sum()) + distinct pattern
  group_by(trial_type, rel_time, cluster_id, n_trials, brain_region, area) %>%
  summarise(total_event_count = sum(event_count), .groups = "drop") %>%
  # Step 3: Calculate rate (same formula as original)
  mutate(rate = total_event_count / n_trials / 0.001) %>%
  # Step 4: Clean up and calculate Z-score
  select(-total_event_count, -n_trials) %>%
  group_by(trial_type, cluster_id) %>%
  mutate(Zscore = (rate - mean(rate)) / sd(rate)) %>%
  ungroup()



g1 <- Trialless %>%
  filter(between(rel_time, -10, 10)) %>%
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  group_by(trial_type) %>%
  mutate(Zscore = Zscore - mean(Zscore))
g2 <- Trialless %>%
  filter(between(rel_time, -10, 10)) %>%
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore))

g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_line() +
  xlim(-0.5, 6)


g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_smooth(method = "loess", span = 0.05) +
  xlim(-0.5, 6)


asymmetric_smooth <- function(x, window_high = 3, window_low = 20, threshold = 0.3) {
  n <- length(x)
  result <- numeric(n)

  for (i in 1:n) {
    if (x[i] > threshold) {
      window <- window_high
    } else {
      window <- window_low
    }

    start <- max(1, i - window %/% 2)
    end <- min(n, i + window %/% 2)
    result[i] <- mean(x[start:end])
  }
  return(result)
}

g2$smoothed1 <- asymmetric_smooth(g2$Zscore)


g2$smoothed2 <- signal::sgolayfilt(g2$Zscore, p = 2, n = 9)

library(zoo)

# Rolling max to preserve peaks
g2$smoothed3 <- rollmax(g2$Zscore, k = 10, fill = NA, align = "center")

# Or combine max and mean
g2$smoothed4 <- 0.7 * rollmax(g2$Zscore, k = 8, fill = NA, align = "center") +
  0.3 * rollmean(g2$Zscore, k = 8, fill = NA, align = "center")



g2 %>%
  pivot_longer(cols = Zscore:smoothed2, names_to = "SA", values_to = "value") %>%
  ggplot(aes(rel_time, value, col = SA)) +
  geom_line() +
  xlim(-0.5, 5)



g2 %>%
  pivot_longer(cols = Zscore:smoothed2, names_to = "SA", values_to = "value") %>%
  ggplot(aes(rel_time, value)) +
  geom_line() +
  xlim(-0.5, 5) +
  facet_wrap(~SA)


library(dplyr)





g2 %>% ggplot(aes(rel_time, smoothed1, col = as.factor(trial_type))) +
  geom_line() +
  xlim(-0.5, 6)

g1 %>% ggplot(aes(rel_time, Zscore, col = as.factor(trial_type))) +
  geom_smooth(method = "loess", span = 0.2) +
  xlim(-0.5, 6)
```




# find fear signatures

```{r}
m <- data %>% filter(Animal=='M3') %>% filter()


m %>% filter(between(rel_time,-1,7)) %>% ggplot(aes(rel_time,event_count,col=condition))+
  geom_smooth(method='loess',span=0.3,se=F)+
  facet_wrap(~trial_type)
```



# is Opto real ?
```{r}
# bin to 100 ms
su <- data %>% filter(Animal != 'M2') %>% filter(between(rel_time,-10,10)) %>% mutate(rel_time = round(rel_time,1)) %>% group_by(cluster_id,rel_time,trial_type) %>% summarise(Ap = mean(event_count))

# find baseline for Z score
baseline <- su %>% filter(rel_time <= -1) %>% group_by(cluster_id) %>%  summarise( meanbl = mean(Ap), sdbl = sd(Ap))

# calculate Zscore
sub <- su %>% left_join(baseline) %>% group_by(cluster_id) %>%  mutate(Zscore = (Ap - meanbl) /sdbl) %>% ungroup()

# calculate pre and during stimulus firing rate for each unit x trial type
sub <- sub %>% left_join( sub %>% filter(rel_time<0) %>% group_by(cluster_id,trial_type) %>% summarise(pre = mean(Zscore))) %>% left_join( sub %>% filter(between(rel_time,0,5)) %>% group_by(cluster_id,trial_type) %>% summarise(during = mean(Zscore))) 


# define opto response patterns
subb <- sub %>% ungroup() %>%  mutate(diff = during - pre) %>% 
  mutate(type = case_when(
    diff >0.2 ~ 'increase',
    diff < -0.2 ~'decrease', .default =  'no change')) %>% ungroup()

subb %>% ggplot(aes(rel_time,Zscore))+
  geom_col()+
  facet_grid(type~trial_type)

subb %>% distinct(cluster_id,type,trial_type) %>% count(trial_type,type) %>% ggplot(aes(trial_type,n,fill=type))+
  geom_col()


# Option 1
# look at units whose activity was lower in the opto compared to the Non opto 

subfilt <- subb %>% select(cluster_id,trial_type,during) %>% mutate(trial_type = ifelse(trial_type %in% c('Downsweep','Upsweep'),'no','Opto')) %>% group_by(cluster_id, trial_type) %>% summarise(diff = mean(during)) %>% pivot_wider(names_from = trial_type,values_from = diff) %>% mutate(sens = Opto - no) %>% filter(sens <0) %>% select(cluster_id,sens)



# increased activity 
g1 <- Trialless %>% filter(cluster_id %in% T2$cluster_id) %>%  filter(!cluster_id %in% subfilt$cluster_id) %>% 
  filter(between(rel_time, -20, 8)) %>% mutate(rel_time = floor(rel_time)) %>% 
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()

g1 %>% filter(between(rel_time,-5,10))%>% ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_col()+
  facet_wrap(~trial_type)


# decreased
g2 <- Trialless %>% filter(cluster_id %in% T2$cluster_id) %>%  filter(cluster_id %in% subfilt$cluster_id) %>% 
  filter(between(rel_time, -20, 8)) %>% mutate(rel_time = floor(rel_time)) %>% 
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()

g2  %>% filter(between(rel_time,-5,10))%>% ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_col()+
  facet_wrap(~trial_type)


# all
g3 <- Trialless %>% filter(cluster_id %in% T2$cluster_id) %>% filter(Animal != 'M2') %>% 
  filter(between(rel_time, -20, 8)) %>% mutate(rel_time = floor(rel_time)) %>% 
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()

g3 %>% filter(between(rel_time,-5,10))%>% ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_col()+
    geom_line(linewidth=0.1)+
  facet_wrap(~trial_type)


# Option 2
# look at units whose activity decreased compared to baseline

subfilt <- subb %>% filter(type =='decrease') %>% distinct(cluster_id)
# increased activity 
g1 <- Trialless %>% filter(cluster_id %in% T2$cluster_id) %>%  filter(!cluster_id %in% subfilt$cluster_id) %>% 
  filter(between(rel_time, -20, 8)) %>% mutate(rel_time = floor(rel_time)) %>% 
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()

g1 %>% filter(between(rel_time,-5,10))%>% ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_col()+
  facet_wrap(~trial_type)


# decreased
g2 <- Trialless %>% filter(cluster_id %in% T2$cluster_id) %>%  filter(cluster_id %in% subfilt$cluster_id) %>% 
  filter(between(rel_time, -20, 8)) %>% mutate(rel_time = floor(rel_time)) %>% 
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()

g2  %>% filter(between(rel_time,-5,10))%>% ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_col()+
  facet_wrap(~trial_type)


# all
g3 <- Trialless %>% filter(cluster_id %in% T2$cluster_id) %>% filter(Animal != 'M2') %>% 
  filter(between(rel_time, -20, 8)) %>% mutate(rel_time = floor(rel_time)) %>% 
  group_by(rel_time, trial_type) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(trial_type) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()

g3 %>% filter(between(rel_time,-5,10))%>% ggplot(aes(rel_time, Zscore,col=trial_type)) +
  geom_col()+
    geom_line(linewidth=0.1)+
  facet_wrap(~trial_type)





# recreate graphs 
 
Opto_un <-   subb %>% select(cluster_id,trial_type,during) %>% mutate(trial_type = ifelse(trial_type %in% c('Downsweep','Upsweep'),'no','Opto')) %>% group_by(cluster_id, trial_type) %>% summarise(diff = mean(during)) %>% pivot_wider(names_from = trial_type,values_from = diff) %>% mutate(sens = Opto - no)  %>% mutate(senscat = case_when(
    sens < -0.25~ 'reduced',
    sens > 0.25 ~ 'increased',
    .default = 'no change'
  )) %>% filter(cluster_id %in% T2$cluster_id) %>% ungroup() 

Opto_un%>% distinct(senscat,cluster_id) %>% 
    ggplot(aes(x='',y=senscat,fill=senscat))+
    geom_bar(stat="identity")+
    coord_polar('y',start=0)
    theme_void()
Opto_un %>%
  distinct(senscat, cluster_id) %>%
  count(senscat) %>%
  ggplot(aes(x = "", y = n, fill = senscat)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  theme_void()
ggsave('D:/figures/Opto_resp.svg')

Opto_un %>% ggplot(aes(senscat))+
  geom_bar(aes(fill=senscat))

####
  

asymmetric_smooth <- function(x, window_high = 4, window_low = 25, threshold = 0.25) {
  n <- length(x)
  result <- numeric(n)

  for (i in 1:n) {
    if (x[i] > threshold) {
      window <- window_high
    } else {
      window <- window_low
    }

    start <- max(1, i - window %/% 2)
    end <- min(n, i + window %/% 2)
    result[i] <- mean(x[start:end])
  }
  return(result)
}



g1 <- Trialless %>%  filter(cluster_id %in% Opto_un$cluster_id) %>% 
  filter(between(rel_time, -20, 8)) %>% left_join(Opto_un %>% select(cluster_id,senscat)) %>% 
  group_by(rel_time, trial_type,senscat) %>%
  summarise(Zscore = mean(Zscore)) %>%
  ungroup() %>% filter(Zscore < Inf) %>%  group_by(trial_type,senscat) %>% mutate(Zscore = Zscore - mean(Zscore)) %>% ungroup()


g1 <- g1 %>%
  group_by(senscat,trial_type) %>%
  mutate(smoothed1 = asymmetric_smooth(Zscore,window_high = 3, window_low = 20, threshold = 0.1))



g1 %>% filter(between(rel_time,-0.2,1.2)) %>%  filter(senscat =='reduced') %>% ggplot(aes(rel_time, smoothed1, col = as.factor(trial_type)))+
  geom_line()

g1 %>% mutate(trial_type = ifelse(trial_type %in% c('Downsweep','Upsweep'),'No_Opto','Opto')) %>% 
filter(between(rel_time,-1,7)) %>% mutate(rel_time= floor(rel_time/1)*1) %>% group_by(rel_time,trial_type,senscat) %>% summarise( smoothed1 = mean(smoothed1)) %>% ggplot(aes(rel_time, smoothed1)) +
  geom_col()+
  facet_grid(trial_type~senscat)+
  theme_minimal()
ggsave('D:/figures/Opto_resp.svg')
```


